# ç¬¬17ç»„ äº‘åŸç”Ÿå¤§ä½œä¸šè¯´æ˜æ–‡æ¡£

> äº‘åŸç”Ÿæ–—åœ°ä¸» GROUP nju17

é¡¹ç›®åœ°å€ï¼š

ğŸ‘‰ğŸ‘‰ğŸ‘‰[github](https://github.com/T-THA/Cloud-Native)

ğŸ‘‰ğŸ‘‰ğŸ‘‰[gitee](https://gitee.com/irisalt/cloud-native)

## å°ç»„æˆå‘˜

|    å§“å    |     å­¦å·      |
|:--------:|:-----------:|
|   å¼ é“­é“­    |  211250234  |
|   èƒ¡å®¶ç¿    |  211250020  |
|   å®‹æ¯…æ’    |  211250022  |


## åŠŸèƒ½è¦æ±‚

### **å®ç°æ¥å£å’Œé™æµåŠŸèƒ½**

åœ¨é¡¹ç›®ä¸­æ–°å»ºä¸€ä¸ª``Controller``ï¼Œå®ç°Restæ¥å£å¦‚ä¸‹ï¼š
```java
@RestController
public class DemoController {

    private final RateLimiter rateLimiter = RateLimiter.create(100.0);

    @GetMapping("/api/text")
    @ResponseStatus(HttpStatus.OK)
    @ResponseBody
    public String getText(){
        if(!rateLimiter.tryAcquire(1))
            throw new HttpStatusCodeException(HttpStatus.TOO_MANY_REQUESTS) {
            };
        return "{\"name\":\"äº‘åŸç”Ÿæ–—åœ°ä¸»\",\"number\":\"nju17\"}";
    }

    @GetMapping( "/api/json")
    @ResponseStatus(HttpStatus.OK)
    @ResponseBody
    public String getJson() {
        if(!rateLimiter.tryAcquire(1)) {
            throw new HttpStatusCodeException(HttpStatus.TOO_MANY_REQUESTS) {};
        }
        JSONObject json = new JSONObject();
        try {
            json.put("name", "äº‘åŸç”Ÿæ–—åœ°ä¸»");
            json.put("number", "nju17");
        } catch (JSONException e) {
            throw new RuntimeException(e);
        }
        String ret = json.toString();
        return ret;
    }
}
```
å…¶ä¸­ï¼Œé™æµåŠŸèƒ½ä½¿ç”¨äº†```RateLimiter```ç›¸å…³æ¥å£æ¥å®ç°ï¼Œé™åˆ¶æ¯ç§’æœ€å¤šå¤„ç†100ä¸ªè¯·æ±‚ã€‚å¦‚æœè¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œåˆ™ä¼šè¿”å›```429```é”™è¯¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼ˆä½¿ç”¨```springboot test```æµ‹è¯•ï¼‰:
![429](429.PNG)
æœ¬åœ°è¿è¡Œåï¼Œè¯¥æ¥å£å¯ä»¥é€šè¿‡è®¿é—®```http://localhost:8080/api/json``` æˆ– ```http://localhost:8080/api/text``` æ¥æµ‹è¯•å¯ç”¨æ€§ï¼š
![json](json.PNG)

### **å®ç°Prometheusç›‘æ§**
åœ¨é¡¹ç›®çš„application.propertiesä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š
![prometheus](prometheus.png)
å¹¶åœ¨pom.xmlä¸­æ·»åŠ ç›¸å…³ä¾èµ–ï¼š
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
<dependency>
    <groupId>io.micrometer</groupId>
    <artifactId>micrometer-registry-prometheus</artifactId>
</dependency>
```
æœ¬åœ°è¿è¡Œåï¼Œå³å¯åœ¨```http://localhost:8080/actuator/prometheus``` ä¸­æŸ¥çœ‹åˆ°ç›¸å…³ç›‘æ§ä¿¡æ¯ï¼š
![prometheus2](prometheus2.png)

### **ç»Ÿä¸€é™æµ**

ç»Ÿä¸€é™æµæš‚æœªå®ç°~

## DevOps è¦æ±‚

### **Dockerfileä¸K8så®¹å™¨ç¼–æ’**

- Dockerfile
  ![dockerfile](dockerfile.PNG)
- deployment.yaml
  ![deployment](deployment.yaml.PNG)

ç›¸å…³æ³¨è§£åœ¨ä»£ç æ³¨é‡Šä¸­ã€‚æˆªå›¾ä¸­çš„ä»£ç é€‚é…ä¸‹è¿°æ–¹æ¡ˆäºŒæµæ°´çº¿ï¼Œåœ¨Jenkinséƒ¨åˆ†ä¼šè¿›è¡Œè¯´æ˜ã€‚

ä¸‹è¿°éƒ¨åˆ†æ˜¯å¦å¤–ä¸€å¥—æ–‡ä»¶ï¼Œé€‚é…æ–¹æ¡ˆä¸€æµæ°´çº¿ï¼š
- Dockerfile
  ![dockerfile](dockerfile2.PNG)
- deployment.yaml ä»…ä¿®æ”¹å›¾ç¤ºéƒ¨åˆ†
  ![deployment](deployment.yaml2.PNG)

### **Jenkins**

ç”±äºè½¯é™¢JenkinsæœåŠ¡å™¨çš„masterèŠ‚ç‚¹ä¸€ç›´è¢«å ç”¨ï¼Œå› æ­¤æˆ‘ä»¬åŸæœ¬åšå¥½çš„Jenkinæµæ°´çº¿æ— æ³•è¿è¡Œï¼Œåæ¥ä¸´æ—¶åšäº†å¦ä¸€æ¡æµæ°´çº¿ã€‚ç»“æœåé¢masterèŠ‚ç‚¹åˆæ­£å¸¸å·¥ä½œï¼ŒåˆæˆåŠŸè¿è¡Œäº†åŸæœ¬çš„æ–¹æ¡ˆã€‚ä¸¤å¥—æ–¹æ¡ˆå¦‚ä¸‹ï¼š

- æ–¹æ¡ˆä¸€ï¼šåŸæœ¬çš„Jenkinæµæ°´çº¿æ–¹æ¡ˆï¼ŒåŒæ—¶ä½¿ç”¨äº†masterèŠ‚ç‚¹å’ŒslaveèŠ‚ç‚¹è¿›è¡Œæ„å»ºï¼Œå…¶ä¸­masterèŠ‚ç‚¹å®Œæˆäº†æŒç»­é›†æˆçš„åŠŸèƒ½ï¼ŒslaveèŠ‚ç‚¹å®Œæˆäº†æŒç»­éƒ¨ç½²çš„åŠŸèƒ½ã€‚æµæ°´çº¿å¦‚ä¸‹ï¼š
```groovy
pipeline {
    agent none
    stages {
        stage('Clone Code') {
            agent {
                label 'master'
            }
            steps {
                echo "1.Clone From Gitee"
                sh 'curl "http://p.nju.edu.cn/portal_io/login?' +
                        'username=' + '211250234' +
                        '&' +
                        'password=' + 'xxxxxxx' + '"' //å¯†ç å·²éšè—
                git url: 'https://gitee.com/irisalt/cloud-native.git', branch: 'main'
            }
        }

        stage('Maven Build') {
            agent {
                docker {
                    image 'maven:latest'
                    args ' -v /root/.m2:/root/.m2'
                }
            }
            steps {
                echo "2. Using Maven to Build"
                sh 'mvn -B clean package'
            }
        }

        stage('Build Image') {
            agent {
                label 'master'
            }
            steps {
                echo "3. Build Image"
                sh 'docker build -t cloud-native:${BUILD_ID} .'
                sh 'docker tag cloud-native:${BUILD_ID} harbor.edu.cn/nju17/cloud-native:${BUILD_ID}'
            }
        }

        stage('Push Image') {
            agent {
                label 'master'
            }
            steps {
                echo "4. Push Docker Image"
                sh 'docker login harbor.edu.cn ' +
                        '-u ' + 'nju17' +
                        ' -p ' + 'nju172023'
                sh 'docker push harbor.edu.cn/nju17/cloud-native:${BUILD_ID}'
            }
        }
    }
}

node('slave') {
    container('jnlp-kubectl') {
        stage('Clone & Change YAML') {
            echo "5. Clone YAML to Slave and Change YAML"
            //xxx needs to be replaced
            sh 'curl "http://p.nju.edu.cn/portal_io/login?' +
                    'username=' + '211250234' +
                    '&' +
                    'password=' + 'xxxxxxx' + '"' //å¯†ç å·²éšè—
            git url: 'https://gitee.com/irisalt/cloud-native.git', branch: 'main'
            sh 'sed -i "s#{VERSION}#${BUILD_ID}#g" deployment.yaml'
        }

        stage ('Deploy') {
            echo "6. Deploy to K8s"
            //xxx needs to be replaced
            sh 'curl "http://p.nju.edu.cn/portal_io/login?' +
                    'username=' + '211250234' +
                    '&' +
                    'password=' + 'xxxxxxx' + '"' //å¯†ç å·²éšè—
            sh 'docker login harbor.edu.cn ' +
                        '-u ' + 'nju17' +
                        ' -p ' + 'nju172023'
            sh 'docker pull harbor.edu.cn/nju17/cloud-native:${BUILD_ID}'
            sh 'kubectl apply -f deployment.yaml -n nju17'
        }

        stage('Monitor') {
            echo "7. Start Monitor"
            sh 'kubectl apply -f monitor.yaml -n monitoring'
        }
    }
}
```
  slaveèŠ‚ç‚¹å®Œæˆäº†ä»é•œåƒä»“åº“æ‹‰å–é•œåƒï¼Œéƒ¨ç½²åˆ°K8sé›†ç¾¤çš„ä»»åŠ¡ã€‚åœ¨éƒ¨ç½²æ—¶ï¼Œä¼šè‡ªåŠ¨ä¿®æ”¹deployment.yamlæ–‡ä»¶ä¸­çš„é•œåƒTAGï¼Œä»¥å®ç°æŒç»­éƒ¨ç½²çš„åŠŸèƒ½ã€‚

  masterèŠ‚ç‚¹å®Œæˆäº†ä»£ç ä¸Šä¼ ï¼Œé•œåƒæ„å»ºï¼Œä¸Šä¼ åˆ°é•œåƒä»“åº“çš„ä»»åŠ¡ã€‚æ­¤å¤–åœ¨Mavenæ„å»ºæ—¶ï¼Œå·²ç»é€šè¿‡äº†æœ¬åœ°å†™å¥½çš„å•å…ƒæµ‹è¯•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    ![test](test.png)
  ç¼–å†™çš„å•å…ƒæµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š
  ```java
  @SpringBootTest
  class CloudNativeApplicationTests {
      private DemoController demoController = new DemoController();
      private static final String EXPECTED_TEXT = "{\"name\":\"äº‘åŸç”Ÿæ–—åœ°ä¸»\",\"number\":\"nju17\"}";
      @BeforeEach
      void initAll() {demoController = new DemoController();}
      @Test
      void testGetText() { // æµ‹è¯•å¯ç”¨æ€§
          String result = demoController.getText();
          assert(result.equals(EXPECTED_TEXT));
      }
      @Test
      void test429(){ // æµ‹è¯•é™æµåŠŸèƒ½ï¼Œåº”è¯¥çˆ†429å¹¶ä¸”é€šè¿‡æµ‹è¯•
          try {
              for(int i = 0; i < 100; i++) {
                  Thread.sleep(5);
                  demoController.getText();
              }
              assert false;
          } catch (Exception e) {
              assert(e.getMessage().equals("429 TOO_MANY_REQUESTS"));
          }
      }
      @Test
      void test429Two(){ // æµ‹è¯•é™æµåŠŸèƒ½ï¼Œåº”è¯¥çˆ†429å¹¶ä¸”é€šè¿‡æµ‹è¯•
          try {
              for(int i = 0; i < 100; i++) {
                  demoController.getText();
              }
              assert false;
          } catch (Exception e) {
              assert(e.getMessage().equals("429 TOO_MANY_REQUESTS"));
          }
      }
      @Test
      void testEdge(){ // è¾¹ç•Œæµ‹è¯•ï¼Œåº”è¯¥è¡¨ç°ä¸ºä¸ä¼šçˆ†429
          try {
              for(int i = 0; i < 100; i++) {
                  Thread.sleep(11);
                  demoController.getText();
              }
              assert true;
          } catch (Exception e) {
              if(e.getMessage().equals("429 TOO_MANY_REQUESTS")){
                  assert false;
              };
              assert true;
          }
      }
  }
  ```

  æµæ°´çº¿æ„å»ºç»“æœå¦‚ä¸‹ï¼š
    ![jenkins](jenkins5.png)
    ![jenkins](jenkins6.png) 


- æ–¹æ¡ˆäºŒï¼šç”±äºå‡†å¤‡å¼€å§‹æ„å»ºæµæ°´çº¿çš„æ—¶å€™masterèŠ‚ç‚¹éƒ½ç”¨ä¸äº†ï¼Œå› æ­¤å¾—ä¿®æ”¹æµæ°´çº¿ã€‚è¿™æ˜¯å› ä¸ºmasterèŠ‚ç‚¹å’ŒslaveèŠ‚ç‚¹çš„åŠŸèƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œç»è¿‡æœ¬äººæµ‹è¯•ï¼Œåœ¨slaveèŠ‚ç‚¹ä¸Šæˆ‘ä»¬æ— æ³•ä½¿ç”¨``mvn`` ``docker``ç­‰å‘½ä»¤ï¼ˆåº”è¯¥æ˜¯æ²¡æœ‰é¢„è£…ç›¸å…³çš„ç¯å¢ƒï¼‰ã€‚å› æ­¤å°ç»„åŒæ—¶ä½¿ç”¨äº†å¦ä¸€å¥—æ–¹æ¡ˆï¼š
  - åœ¨æœ¬åœ°æ‰‹åŠ¨å°†dockeré•œåƒä¸Šä¼ åˆ°é•œåƒä»“åº“ï¼Œå¹¶æ‰‹åŠ¨æŒ‡å®šTAGï¼š
    ![docker](docker.png)
  - æ„å»ºæµæ°´çº¿å¦‚ä¸‹ï¼Œè¯¥æµæ°´çº¿å®é™…ä¸Šå®ç°äº†æŒç»­éƒ¨ç½²çš„åŠŸèƒ½ï¼š
    ```groovy
    pipeline {
      agent none
      stages {
          stage('Clone Code') {
              agent {
                  label 'slave'
              }
              steps {
                  echo "1.Clone From Gitee"
                  //xxx needs to be replaced
                  sh 'curl "http://p.nju.edu.cn/portal_io/login?' +
                          'username=' + '211250234' +
                          '&' +
                          'password=' + 'xxxxxxx' + '"' //å¯†ç å·²éšè—
                  git url: 'https://gitee.com/irisalt/cloud-native.git', branch: 'main'
              }
          }
      }
    }
    
    node('slave') {
    container('jnlp-kubectl') {
    stage('Clone & Change YAML') {
    echo "2. Clone YAML to Slave and Change YAML"
    //xxx needs to be replaced
    sh 'curl "http://p.nju.edu.cn/portal_io/login?' +
    'username=' + '211250234' +
    '&' +
    'password=' + 'xxxxxxx' + '"' //å¯†ç å·²éšè—
    git url: 'https://gitee.com/irisalt/cloud-native.git', branch: 'main'
    }

        stage ('Deploy') {
            echo "3. Deploy to K8s"
            //xxx needs to be replaced
            sh 'curl "http://p.nju.edu.cn/portal_io/login?' +
                    'username=' + '211250234' +
                    '&' +
                    'password=' + 'xxxxxxx' + '"' //å¯†ç å·²éšè—
            sh 'docker login harbor.edu.cn ' +
                    '-u ' + 'nju17' +
                    ' -p ' + 'nju172023'
            sh 'docker pull harbor.edu.cn/nju17/cloud-native:9'
            // sh 'kubectl delete deployment cloud-native -n nju17'
            sh 'kubectl apply -f deployment.yaml -n nju17'
            // sh 'kubectl scale deployment cloud-native --replicas 1 -n nju17'
        }

        stage('Monitor') {
            echo "4. Start Monitor"
            sh 'kubectl apply -f monitor.yaml -n monitoring'
        }
      }
    }
    ```
    
å®é™…è¿è¡Œçš„æƒ…å†µå¦‚ä¸‹ï¼Œè®¿é—®çš„urlä¸º``http://172.29.4.18:32510/`` ï¼š
![jenkins](jenkins.png)
![jenkins2](jenkins2.jpg)
![jenkins3](jenkins3.jpg)
![jenkins4](jenkins4.png)

## æ‰©å®¹åœºæ™¯

### **Prometheus metricsæ¥å£**
é…ç½®ä¸€ä¸ªServiceMonitorï¼Œç”¨äºç›‘æ§åº”ç”¨çš„metricsæ¥å£ï¼Œè®¿é—®çš„urlä¸º``http://172.29.4.18:32510/actuator/prometheus``ï¼Œé…ç½®å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
![monitor](monitor.yaml.PNG)

### **Grafanaç›‘æ§**
æµæ°´çº¿éƒ¨ç½²å®Œæˆåï¼Œåœ¨è½¯ä»¶ç ”å‘æ•ˆèƒ½æ”¯æ’‘å¹³å°çš„grafanaå¹³å°ä¸Šå¯ä»¥ç›´æ¥æŸ¥è¯¢åˆ°å¯¹åº”çš„å®¹å™¨å’Œåç©ºé—´ã€‚<br/>
é€šè¿‡å¯è§†åŒ–å·¥å…·å¯ä»¥ç›´æ¥åˆ›å»ºæ‰€éœ€çš„å›¾è¡¨ï¼ˆå¦‚ä¸‹å›¾ï¼‰ã€‚
![grafana1](grafana1.png)
é€šè¿‡æ­¤æ–¹å¼åˆ›å»ºCPUã€å†…å­˜ã€JVMçš„ç©ºé—´ä½¿ç”¨å›¾è¡¨ï¼ˆå¦‚ä¸‹å›¾ï¼‰ã€‚
![grafana2](grafana2.png)


### **å‹åŠ›æµ‹è¯•**

- ä½¿ç”¨Apifoxè¿›è¡Œå‹åŠ›æµ‹è¯•

  åœ¨Apifoxä¸­æ·»åŠ å®ç°çš„æ¥å£ï¼ˆå¦‚ä¸‹å›¾ï¼‰ã€‚
  ![Apifox1](Apifox1.png)
  ä½¿ç”¨Apifoxçš„è‡ªåŠ¨åŒ–æµ‹è¯•åŠŸèƒ½,è®¾ç½®å¾ªç¯æ¬¡æ•°ä¸º10æ¬¡ï¼Œçº¿ç¨‹æ•°ä¸º20(å¦‚ä¸‹å›¾)ã€‚
  ![Apifox2](Apifox1.png)
  æµ‹è¯•å®Œæˆåå¯ä»¥æŸ¥çœ‹grafanaä¸­å®¹å™¨å†…å­˜ä½¿ç”¨æœ‰æ˜æ˜¾ä¸Šå‡ï¼ˆç”±äºç½‘ç»œé™åˆ¶æµ‹è¯•æ—¶é—´èŠ±è´¹è¾ƒé•¿ï¼Œæ•…æ²¡æœ‰è§¦å‘é™æµï¼‰ã€‚
  ![Apifox3](Apifox2.png)
  ![grafana3](grafana3.png)

- ä½¿ç”¨Apache JMeterè¿›è¡Œå‹åŠ›æµ‹è¯•
  
  ç”±äºApiFoxçš„æµ‹è¯•æ—¶é—´è¾ƒé•¿ï¼Œæ²¡æœ‰è¾¾åˆ°ç†æƒ³çš„æ•ˆæœï¼Œæ•…å†é‡‡ç”¨Apache JMeterè¿›è¡Œå‹åŠ›æµ‹è¯•ã€‚
  ![JMeter1](JMeter1.png)
  æµ‹è¯•å®Œæˆåå¯ä»¥çœ‹åˆ°å‡ºç°äº†429é”™è¯¯ï¼Œè¯´æ˜é™æµåŠŸèƒ½æ­£å¸¸ã€‚
  ![JMeter2](JMeter2.png)
  æŸ¥çœ‹ç›‘æ§å¤§å±ï¼Œå¤§å±å‡ºç°äº†æ˜æ˜¾çš„èµ„æºå ç”¨ä¸Šå‡ï¼š
  ![JMeter2](JMeter3.png)

### **æ‰‹å·¥æ‰©å®¹**

å¯ä»¥ä¿®æ”¹deployment.yamlæ–‡ä»¶ä¸­replicasçš„å€¼ï¼Œå†æ¬¡éƒ¨ç½²ã€‚æ­¤å¤„é‡‡å–ä¿®æ”¹æµæ°´çº¿çš„æ–¹å¼ï¼Œç›´æ¥ä¿®æ”¹Deployé˜¶æ®µï¼Œå¢åŠ å¯¹replicasçš„ä¿®æ”¹ï¼š
```groovy
// å…¶ä½™éƒ¨åˆ†çœæµ

stage ('Deploy') {
    echo "3. Deploy to K8s"
    sh 'curl "http://p.nju.edu.cn/portal_io/login?' +
            'username=' + '211250234' +
            '&' +
            'password=' + 'xxxxxxx' + '"' //å¯†ç å·²éšè—
    sh 'docker login harbor.edu.cn ' +
            '-u ' + 'nju17' +
            ' -p ' + 'nju172023'
    sh 'docker pull harbor.edu.cn/nju17/cloud-native:9'
    // sh 'kubectl delete deployment cloud-native -n nju17'
    sh 'kubectl apply -f deployment.yaml -n nju17'
     sh 'kubectl scale deployment cloud-native --replicas 3 -n nju17'
}
```
å¢åŠ ``sh 'kubectl scale deployment cloud-native --replicas 3 -n nju17'``å³å¯åœ¨éƒ¨ç½²æ—¶å®ç°æ‰©å®¹ï¼Œæ‰©å®¹ç»“æœå¦‚ä¸‹ã€‚
![scale](scale.png)
æ‰©å®¹åï¼Œå†æ¬¡å¯¹æ¥å£è¿›è¡Œå‹åŠ›æµ‹è¯•ï¼Œå¯ä»¥çœ‹åˆ°å‹åŠ›æµ‹è¯•çš„ç»“æœå¦‚ä¸‹ï¼Œè¯·æ±‚æˆåŠŸçš„æ¬¡æ•°å¤§å¤§å¢åŠ ï¼š
![scale2](JMeter4.png)
ç›‘æ§å¤§å±ä¹Ÿå¯ä»¥è§‚å¯Ÿåˆ°ç›¸åº”çš„å˜åŒ–ï¼Œcontainerå˜ä¸º3ä¸ªï¼Œæ›²çº¿å‘ˆä¸Šå‡è¶‹åŠ¿ï¼š
![scale3](JMeter5.png)
æ‰©å®¹å‰åå¯¹æ¯”ï¼š
![scale4](JMeter6.png)
 
### **è‡ªåŠ¨æ‰©å®¹**

è‡ªåŠ¨æ‰©å®¹ä¸å†™äº†~
